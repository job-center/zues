<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,user-scalable=0,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
<meta name="format-detection" content="telephone=no" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="apple-mobile-web-app-capable" content="yes">
<title>支付下单</title>
<link href="css/style.css" rel="stylesheet" type="text/css" />
<style>
.order-confirm.ico-time{border-top:none; position:relative}
.ico-time span{display:inline-block; position:absolute; left:144px; top:6px;line-height:23px;text-indent:0}
</style>
<script type="text/javascript" src="js/jquery.min.js" ></script>
<script type="text/javascript" charset="UTF-8" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
    $(function(){

        //获取用户信息
        var mobile = null;
        var account_id = null;
        $.ajax({
            url:'/account/listAccount',
            type:'GET',
            async:false,
            success:function(result){
                if(result.success){
                    mobile = result.data.mobile;
                    account_id = result.data.accountId;
                }else if(result.code==320){
                    $("#div_text").text(result.detail);
                    $("#alert").show();
                    $("#button_confirm").unbind("click");
                    $("#button_confirm").one("click",function(){
                        window.location.href = "login.html"
                    });
                    return;
                }
            },failure:function(){
                alert("系统错误");
            }
        });

        //获取请求参数
        function GetRequest() {
            var url = location.search; //获取url中"?"符后的字串
            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                var strs = str.split("&");
                for(var i = 0; i < strs.length; i ++) {
                    theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
                }
            }
            return theRequest;
        }
        //拼凑页面与参数
        var requestParam = GetRequest();
        var order_type = requestParam.order_type;
        var startDate = requestParam.startDate;
        var endDate = requestParam.endDate;
        var service_type = requestParam.service_type;
        var animalsId = requestParam.animalsId;
        var order_type_inner_name = null;
        var dataDiff = null;
        var money = null;
        if(order_type==1){
            var order_type_name = "寄养";
            var room_id = requestParam.room_id;
            service_type = 1;
            var service_type_name = "到店服务";
            order_type_inner_name = null;
            //dataDiff = DateDiff(startDate,endDate);
            dataDiff = calDays(startDate,endDate);
            var dataDisplay = startDate+" 至"+endDate;
            $.ajax({
                url:'/room/indexForJson',
                type:'GET',
                async:false,
                data:"room_id=" + room_id,
                success:function(result){
                    order_type_inner_name = result.roomName;
//                    money = result.cost * dataDiff;
                },failure:function(){
                    alert("系统错误");
                }
            });
            var type_display = order_type_name + "-"+order_type_inner_name+"-"+dataDiff+"天";
        } else if(order_type==2){
            var order_type_name = "训练";
            var course_id = requestParam.course_id;
            service_type = 1;
            var service_type_name = "到店服务";
            order_type_inner_name = null;
            var dataDisplay = "从 " + startDate + " 起";
            $.ajax({
                url:'/course/indexForJson',
                type:'GET',
                async:false,
                data:"course_id=" + course_id,
                success:function(result){
                    console.info(result);
                    order_type_inner_name = result.courseName;
//                    money = result.expense;
                },failure:function(){
                    alert("系统错误");
                }
            });
            var type_display = order_type_name + "-"+order_type_inner_name;
        } else if(order_type==3){
            var order_type_name = "美容";
            var hairdress_id = requestParam.hairdress_id;
            service_type = requestParam.service_type;
            var dataDisplay = "从 " + startDate + " 起";
            if(service_type==0){
                var service_type_name = "上门服务";
            } else {
                var service_type_name = "到店服务";
            }
            order_type_inner_name = null;
            $.ajax({
                url:'/hairdressing/indexForJson',
                type:'GET',
                async:false,
                data:"hairdressing_id=" + hairdress_id,
                success:function(result){
                    console.info(result);
                    order_type_inner_name = result.hairdressingName;
//                    money = result.expense;
                },failure:function(){
                    alert("系统错误");
                }
            });
            var type_display = order_type_name + "-"+order_type_inner_name;
        }

        //下单参数
        if(order_type==1){
            var order_param = {"accountId":account_id,"orderType":order_type,"animalsId":animalsId,
                "serviceType":service_type,"startDate":startDate,"endDate":endDate,"paymentStatus":0,"roomId":room_id
            };
        }else if(order_type==2){
            var order_param = {"accountId":account_id,"orderType":order_type,"animalsId":animalsId,
                "serviceType":service_type,"startDate":startDate,"paymentStatus":0,"courseId":course_id
//                "cost":money
            };
        }else if(order_type==3){
            var order_param = {"accountId":account_id,"orderType":order_type,"animalsId":animalsId,
                "serviceType":service_type,"startDate":startDate,"paymentStatus":0,"hairdressId":hairdress_id
//                "cost":money
            };
        }

        $.ajax({
            url:'/orders/getMoney',
            type:'POST',
            async:false,
            data:order_param,
            success:function(result){
                if(result.success){
                    money = result.data.toFixed(2);
                }else{
                    $("#div_text").text(result.detail);
                    $("#alert").show();
                    return;
                }
            },failure:function(){
                alert("系统错误");
            }
        });


        $("#div").append("<a class='list order-submit ico-check'>您已选择<span>"+type_display+"</span></a>")
                .append("<a class='list order-submit ico-time'>服务时间<span>"+dataDisplay+"</span></a>")
                .append("<a class='list order-submit ico-ask'>特殊要求<span>"+service_type_name+"</span></a>")
                .append("<a class='list order-submit ico-phone'>联系电话<span>"+mobile+"</span></a>")
                .append("<a class='list order-submit ico-price'>服务价格<span>"+money+"元</span></a>")
//                .append("<a class='list order-submit ico-pay' style='border-bottom:none; height:50px; line-height:50px'>支付方式</a>")
//                .append("<div class='pay-metod'>")
//                .append("<a class='list' style='height:25px; line-height:25px'><label><input name='pay-metod' type='radio'>微信支付 (优惠信息及折扣)</label></a>")
//                .append("<a class='list' style='height:40px; line-height:40px'><label><input name='pay-metod' type='radio'>到店支付</label></a></div>")



        //下单按钮
        $("#createOrder").click(function(){
            var val=$("input:radio[name='pay-metod']:checked").val();
            if(val==null){
                $("#div_text").text("请选择支付方式!");
                $("#alert").show();
                return;
            }

            if($(".deal").attr("checked")==false){
                $("#div_text").text("请阅读并同意服务协议!");
                $("#alert").show();
                return;
            }

            $.ajax({
                url:'/orders/create',
                type:'POST',
                async:false,
                data:order_param,
                success:function(result){
                    if(result.success){
                    	var order_id = result.data;
                    	if(val==2){
//                        console.info(result.data);
                        	window.location.href="order-confirm.html?ordersId=" + result.data;
                    	}else{//微信支付
                    		console.log(val);
                    		$.ajax({
                    			url:'/wechat/wxOauth',
                    			type:'GET',
                    			async:false,
                    			data:{"order_id":order_id},
                    			success:function(result){
                    				console.log(result);
                    				location.href=result;
                    				/* $(".choose").click(function(){
                    				    weixinPay(result.data);
                    			    }); */
                    				
                    			},failure:function(){
                    				alert("微信支付失败")
                    			}
                    		})
                    	}
                    }else{
                        $("#div_text").text(result.detail);
                        $("#alert").show();
                        return;
                    }
                },failure:function(){
                    alert("系统错误");
                }
            });
//			window.location.href="order-confirm.html";
        })

        $("#button_confirm").click(function(){
            $("#alert").hide();
        })

        $("#service_btn").click(function(){
            $("#service").show();
        })

        $("#cancle_service").click(function(){
            $("#service").hide();
        })

        function calDays(startDate,endDate){
            console.info(startDate)
            console.info(endDate)
            if(startDate!=null && endDate!=null && startDate!="undefined" && endDate!="undefined"){
            	if(startDate>endDate){
            		$("#div_text").text("离开时间必须大于入住时间!");
                    $("#alert").show();
                    return;
            	}
                var tmp_start = startDate.split(" ")[0];
                var tmp_end = endDate.split(" ")[0];
                var tmp_time = endDate.split(" ")[1].split(":")[0];
                var day = null;
                if(tmp_time >=12) {
                    day = DateDiff(tmp_start,tmp_end) + 1;
                } else {
                    day = DateDiff(tmp_start,tmp_end);
                }
                return day;
            }else{
                return 0;
            }
        }
        
        //日期
        function  DateDiff(sDate1,  sDate2){    //sDate1和sDate2是2006-12-18格式
            var begintime_ms = Date.parse(new Date(sDate1.replace(/-/g, "/"))); //begintime 为开始时间
            var endtime_ms = Date.parse(new Date(sDate2.replace(/-/g, "/")));
            var days=Math.floor((endtime_ms-begintime_ms)/(24*3600*1000));
            return days;
        }
        
        function weixinPay(data){
        	if(typeof WeixinJSBridge == "undefined"){
        		if(document.addEventListener){
        			document.addEventListener('WeixinJSBridgeReady', function(){
        				jsApiCall(data);
        			}, false);
        		}else if (document.attachEvent){
			        document.attachEvent('WeixinJSBridgeReady', function(){
			        	jsApiCall(data);
			        }); 
			        document.attachEvent('onWeixinJSBridgeReady', function(){
			        	jsApiCall(data);
			        });
			    }
        	}else{
        		jsApiCall(data);
        	}
        }

      //调用微信JS api 支付
        function jsApiCall(data){
        	WeixinJSBridge.invoke(
    				'getBrandWCPayRequest',data,
    				function(res){
    					WeixinJSBridge.log(res.err_msg);
    					//alert(res.err_code+res.err_desc+res.err_msg);
    					//支付成功或失败前台判断
 		    	       if(res.err_msg=='get_brand_wcpay_request:ok'){
 		    	    	   alert('恭喜您，支付成功!');
 		    	    	   //更新订单支付状态
 		    	    	   $.ajax({
 		    	    		   url:'/orders/completeOrderPaymentState',
 		    	    		   type:'POST',
 		    	    		   data:order_id,
 		    	    		   success:function(result){
 		    	    			   if(result.success){
 		    	    				   window.location.href="order-confirm.html?ordersId=" + order_id;
 		    	    			   }else{
 		    	    				   alert('更新支付状态失败');
 		    	    			   }
 		    	    		   },failure:function(){
 		    	    			   alert('更新支付状态失败');
 		    	    		   }
 		    	    	   })
 		    	       }else{
 		    	    	   alert('支付失败');
 		    	       }
    				}
    			);
        }
    })
</script>
</head>

<body>

	<div id="div">
        <!--<a class="list order-submit ico-check">您已选择<span>寄养-酒店式-30天</span></a>
        <a class="list order-confirm ico-time">服务时间<span>2015-09-12 12:12 至 <br/>2015-09-13 12:13</span></a>
        <a class="list order-submit ico-ask">特殊要求</a>
        <a class="list order-submit ico-phone">联系电话<span>15010248416</span></a>
        <a class="list order-submit ico-price">服务价格<span>1500元</span></a>-->
    </div>
        <a class="list order-submit ico-pay" style="border-bottom:none; height:50px; line-height:50px">支付方式</a>
        <div class="pay-metod">
            <a class="list" style="height:25px; line-height:25px"><label><input name="pay-metod" type="radio" value="1">微信支付 (优惠信息及折扣)</label></a>
            <a class="list" style="height:40px; line-height:40px"><label><input name="pay-metod" type="radio" value="2">到店支付</label></a>
        </div>

        <div class="list" style="margin-top:10px;border-bottom:none"><label><input class="deal" type="checkbox" checked="true">已阅读，<span>同意<a href="#" id="service_btn" style="text-decoration:underline">服务协议</a></span></label></div>

        <div class="next" id="createOrder" style="margin-top:30px; width:75%">立即下单</div>

    <div id="alert" class="ui-dialog" style="display:none">
        <div class="ui-dialog-cnt">
            <div class="ui-dialog-hd" id="div_text">请选择服务项目</div>
            <div class="ui-dialog-ft">
                <button type="button" data-role="button" id="button_confirm">确定</button>
            </div>
        </div>
    </div>

    <div id="service" class="ui-dialog" style="display:none">
        <div class="deal-cnt">
            <div class="deal-cnt-close" id="cancle_service">X</div>
            <div class="deal-cnt-title">服务协议</div>
            <div class="deal-cnt-p">不得利用本站危害国家安全、泄露国家秘密，不得侵犯国家社会集体的和公民的合法权益，不得利用本站制作、复制和传播下列信息： <br/>
                （一）煽动抗拒、破坏宪法和法律、行政法规实施的；<br/>
                （二）煽动颠覆国家政权，推翻社会主义制度的；<br/>
                （三）煽动分裂国家、破坏国家统一的；<br/>
                （四）煽动民族仇恨、民族歧视，破坏民族团结的；<br/>
                （五）捏造或者歪曲事实，散布谣言，扰乱社会秩序的；<br/>
                （六）宣扬封建迷信、淫秽、色情、赌博、暴力、凶杀、恐怖、教唆犯罪的；<br/>
                （七）公然侮辱他人或者捏造事实诽谤他人的，或者进行其他恶意攻击的；<br/>
                （八）损害国家机关信誉的；<br/>
                （九）其他违反宪法和法律行政法规的；<br/>
                （十）进行商业广告行为的。 <br/>
                二、互相尊重，对自己的言论和行为负责。
                （一）煽动抗拒、破坏宪法和法律、行政法规实施的；<br/>
                （二）煽动颠覆国家政权，推翻社会主义制度的；<br/>
                （三）煽动分裂国家、破坏国家统一的；<br/>
                （四）煽动民族仇恨、民族歧视，破坏民族团结的；<br/>
                （五）捏造或者歪曲事实，散布谣言，扰乱社会秩序的；<br/>
                （六）宣扬封建迷信、淫秽、色情、赌博、暴力、凶杀、恐怖、教唆犯罪的；<br/>
                （七）公然侮辱他人或者捏造事实诽谤他人的，或者进行其他恶意攻击的；<br/>
                （八）损害国家机关信誉的；<br/>
                （九）其他违反宪法和法律行政法规的；<br/>
                （十）进行商业广告行为的。 <br/>

            </div>
        </div>
    </div>


</body>
</html>
