<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,user-scalable=0,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
<meta name="format-detection" content="telephone=no" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="apple-mobile-web-app-capable" content="yes">
<title>支付下单</title>
<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/jquery.min.js" ></script>
<script type="text/javascript">
    $(function(){

        //获取用户信息
        var mobile = null;
        var account_id = null;
        $.ajax({
            url:'/account/listAccount',
            type:'GET',
            async:false,
            success:function(result){
                mobile = result.data.mobile;
                account_id = result.data.accountId;
            },failure:function(){
                alert("系统错误");
            }
        });

        //获取请求参数
        function GetRequest() {
            var url = location.search; //获取url中"?"符后的字串
            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                var strs = str.split("&");
                for(var i = 0; i < strs.length; i ++) {
                    theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
                }
            }
            return theRequest;
        }
        //拼凑页面与参数
        var requestParam = GetRequest();
        var order_type = requestParam.order_type;
        var startDate = requestParam.startDate;
        var endDate = requestParam.endDate;
        var service_type = requestParam.service_type;
        var animalsId = requestParam.animalsId;
        var order_type_inner_name = null;
        var dataDiff = null;
        var money = null;
        if(order_type==1){
            var order_type_name = "寄养";
            var room_id = requestParam.room_id;
            service_type = 0;
            var service_type_name = "到店服务";
            order_type_inner_name = null;
            dataDiff = DateDiff(startDate,endDate);
            var dataDisplay = startDate+" 至 "+endDate;
            $.ajax({
                url:'/room/indexForJson',
                type:'GET',
                async:false,
                data:"room_id=" + room_id,
                success:function(result){
                    order_type_inner_name = result.roomName;
                    money = result.cost * dataDiff;
                },failure:function(){
                    alert("系统错误");
                }
            });

        } else if(order_type==2){
            var order_type_name = "训练";
            var course_id = requestParam.course_id;
            service_type = 0;
            var service_type_name = "到店服务";
            order_type_inner_name = null;
            var dataDisplay = "从 " + startDate + " 起";
            $.ajax({
                url:'/course/indexForJson',
                type:'GET',
                async:false,
                data:"course_id=" + course_id,
                success:function(result){
                    console.info(result);
                    order_type_inner_name = result.courseName;
                    money = result.expense;
                },failure:function(){
                    alert("系统错误");
                }
            });

        } else if(order_type==3){
            var order_type_name = "美容";
            var hairdress_id = requestParam.hairdress_id;
            service_type = requestParam.service_type;
            if(service_type==0){
                var service_type_name = "到店服务";
            } else {
                var service_type_name = "上门服务";
            }
            order_type_inner_name = null;
            $.ajax({
                url:'/hairdressing/indexForJson',
                type:'GET',
                async:false,
                data:"hairdressing_id=" + hairdress_id,
                success:function(result){
                    console.info(result);
                    order_type_inner_name = result.hairdressingName;
                    money = result.expense * dataDiff;
                },failure:function(){
                    alert("系统错误");
                }
            });
        }

        $("#div").append("<a class='list order-submit ico-check'>您已选择<span>"+order_type_name+"-"+order_type_inner_name+"-"+dataDiff+"天</span></a>")
                .append("<a class='list order-submit ico-time'>服务时间<span>"+dataDisplay+"</span></a>")
                .append("<a class='list order-submit ico-ask'>特殊要求<span>"+service_type_name+"</span></a>")
                .append("<a class='list order-submit ico-phone'>联系电话<span>"+mobile+"</span></a>")
                .append("<a class='list order-submit ico-price'>服务价格<span>"+money+"元</span></a>")
//                .append("<a class='list order-submit ico-pay' style='border-bottom:none; height:50px; line-height:50px'>支付方式</a>")
//                .append("<div class='pay-metod'>")
//                .append("<a class='list' style='height:25px; line-height:25px'><label><input name='pay-metod' type='radio'>微信支付 (优惠信息及折扣)</label></a>")
//                .append("<a class='list' style='height:40px; line-height:40px'><label><input name='pay-metod' type='radio'>到店支付</label></a></div>")


        //下单参数
        if(order_type==1){
            var order_param = {"accountId":account_id,"orderType":order_type,"animalsId":animalsId,
                "serviceType":service_type,"startDate":startDate,"endDate":endDate,"paymentStatus":0,"roomId":room_id,
                "cost":money
            };
        }else if(order_type==2){
            var order_param = {"accountId":account_id,"orderType":order_type,"animalsId":animalsId,
                "serviceType":service_type,"startDate":startDate,"paymentStatus":0,"courseId":course_id,
                "cost":money
            };
        }else if(order_type==3){
            var order_param = {"accountId":account_id,"orderType":order_type,"animalsId":animalsId,
                "serviceType":service_type,"startDate":startDate,"paymentStatus":0,"hairdressId":hairdress_id,
                "cost":money
            };
        }



        //下单按钮
        $("#createOrder").click(function(){
            if($(".deal").attr("checked")==false){
                $("#div_text").text("请阅读并同意服务协议!");
                $(".ui-dialog").show();
                return;
            }
            $.ajax({
                url:'/orders/create',
                type:'POST',
                async:false,
                data:order_param,
                success:function(result){
                    console.info(result);
                    if(result.success){

                    }else{
                        $("#div_text").text(result.detail);
                        $(".ui-dialog").show();
                        return;
                    }
                },failure:function(){
                    alert("系统错误");
                }
            });
//			window.location.href="order-confirm.html";
        })

        $("#button_confirm").click(function(){
            $(".ui-dialog").hide();
        })

        //日期
        function  DateDiff(sDate1,  sDate2){    //sDate1和sDate2是2006-12-18格式
            var begintime_ms = Date.parse(new Date(sDate1.replace(/-/g, "/"))); //begintime 为开始时间
            var endtime_ms = Date.parse(new Date(sDate2.replace(/-/g, "/")));
            var days=Math.floor((endtime_ms-begintime_ms)/(24*3600*1000));
            return days;
        }

    })
</script>
</head>

<body>

	<div id="div">
        <!--<a class="list order-submit ico-check">您已选择<span>寄养-酒店式-30天</span></a>-->
        <!--<a class="list order-submit ico-time">服务时间<span>2015-9-17 至 2015-10-01</span></a>-->
        <!--<a class="list order-submit ico-ask">特殊要求</a>-->
        <!--<a class="list order-submit ico-phone">联系电话<span>15010248416</span></a>-->
        <!--<a class="list order-submit ico-price">服务价格<span>1500元</span></a>-->
    </div>
        <a class="list order-submit ico-pay" style="border-bottom:none; height:50px; line-height:50px">支付方式</a>
        <div class="pay-metod">
            <a class="list" style="height:25px; line-height:25px"><label><input name="pay-metod" type="radio">微信支付 (优惠信息及折扣)</label></a>
            <a class="list" style="height:40px; line-height:40px"><label><input name="pay-metod" type="radio">到店支付</label></a>
        </div>

        <div class="list" style="margin-top:10px;border-bottom:none"><label><input class="deal" type="checkbox" checked="true">已阅读，<span>同意<a href="#" style="text-decoration:underline">服务协议</a></span></label></div>

        <div class="next" id="createOrder" style="margin-top:30px; width:75%">立即下单</div>

    <div class="ui-dialog" style="display:none">
        <div class="ui-dialog-cnt">
            <div class="ui-dialog-hd" id="div_text">请选择服务项目</div>
            <div class="ui-dialog-ft">
                <button type="button" data-role="button" id="button_confirm">确定</button>
            </div>
        </div>
    </div>


</body>
</html>
